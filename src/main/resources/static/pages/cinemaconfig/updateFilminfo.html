<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link rel="stylesheet" type="text/css" media="screen"
	href="../../css/bootstrap.min.css">
</head>
<body>
	<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
		<form class="form-horizontal" onsubmit="return false" id="form" action="" enctype="multipart/form-data">
			<fieldset>
				<input id="Id" name="id" type="hidden">
				
				<div class='form-group'>
					<label class='col-md-2 control-label'>影片编码<font
						style="color: red">*</font></label>
					<div class='col-md-10'>
						<input class='form-control' placeholder='影片编码' type='text'
							name='filmCode' id='FilmCode' data-bv-notempty='true'
							data-bv-notempty-message='影片编码 不能为空'>
					</div>
				</div>
				<div class='form-group'>
					<label class='col-md-2 control-label'>影片名称<font
						style="color: red">*</font></label>
					<div class='col-md-10'>
						<input class='form-control' placeholder='影片名称' type='text'
							name='filmName' id='FilmName' data-bv-notempty='true'
							data-bv-notempty-message='影片名称 不能为空'>
					</div>
				</div>
				<div class='form-group'>
					<label class='col-md-2 control-label'>影片版本</label>
					<div class='col-md-10'>
						<input class='form-control' placeholder='影片版本' type='text'
							name='version' id='Version' data-bv-notempty='false'
							data-bv-notempty-message='影片版本 可以为空'>
					</div>
				</div>
				
				<div class='form-group'>
					<label class='col-md-2 control-label'>影片时长</label>
					<div class='col-md-10'>
						<input class='form-control' placeholder='影片时长' type='text'
							name='duration' id='Duration' data-bv-notempty='false'
							data-bv-notempty-message='影片时长 可以为空'>
					</div>
				</div>
				
				<div class='form-group'>
					<label class='col-md-2 control-label'>发布时间</label>
					<div class='col-md-10'>
						<input class='form-control' placeholder='发布时间' type='text'
							name='publishDate' id='PublishDate' data-bv-notempty='false'
							data-bv-notempty-message='发布时间 可以为空'>
					</div>
				</div>
				
				<div class='form-group'>
					<label class='col-md-2 control-label'>发行方</label>
					<div class='col-md-10'>
						<input class='form-control' placeholder='发行方' type='text'
							name='publisher' id='Publisher' data-bv-notempty='false'
							data-bv-notempty-message='发行方可以为空'>
					</div>
				</div>
				
				<div class='form-group'>
					<label class='col-md-2 control-label'>制片人</label>
					<div class='col-md-10'>
						<input class='form-control' placeholder='制片人' type='text'
							name='producer' id='Producer' data-bv-notempty='false'
							data-bv-notempty-message='制片人 可以为空'>
					</div>
				</div>
				
				<div class='form-group'>
					<label class='col-md-2 control-label'>可选导演列表：</label>
					<div class='col-md-10'>
						<button class="btn btn-primary" id="getDirector">选择导演</button>
					</div>
				</div>
				<div class='form-group'>
					<input type="hidden" name="director"  id="Director"/>
					<input type="hidden" name="directorId"  id="DirectorId"/>
					<label class='col-md-2 control-label'>已选导演：</label>
					<div class='col-md-10' id='selectedDirector'>
						
					</div>
				</div>
				
				<div class='form-group'>
					<label class='col-md-2 control-label'>可选演员列表：</label>
					<div class='col-md-10'>
						<button class="btn btn-primary" id="getActor">选择演员</button>
					</div>
				</div>
				<div class='form-group'>
					<input type="hidden" name="cast"  id="Cast" />
					<input type="hidden" name="castId"  id="CastId" />
					<label class='col-md-2 control-label'>已选演员：</label>
					<div class='col-md-10' id='selectedActor'>
						
					</div>
				</div>
				
				<div class='form-group'>
					<label class='col-md-2 control-label'>影片介绍</label>
					<div class='col-md-10'>
						<textarea class="form-control" name="introduction" id='Introduction' rows="4" placeholder="限制500字"></textarea>
					</div>
				</div>
				
				<div class='form-group'>
					<label class='col-md-2 control-label'>评分</label>
					<div class='col-md-10'>
						<input class='form-control' placeholder='评分' type='text'
							name='score' id='Score' data-bv-notempty='false'
							data-bv-notempty-message='评分 可以为空'>
					</div>
				</div>
				
				<div class='form-group'>
					<label class='col-md-2 control-label'>地区</label>
					<div class='col-md-10'>
						<input class='form-control' placeholder='地区' type='text'
							name='area' id='Area' data-bv-notempty='false'
							data-bv-notempty-message='地区 可以为空'>
					</div>
				</div>
				
				<div class='form-group'>
					<label class='col-md-2 control-label'>类型</label>
					<div class='col-md-10'>
						<input class='form-control' placeholder='类型' type='text'
							name='type' id='Type' data-bv-notempty='false'
							data-bv-notempty-message='类型 可以为空'>
					</div>
				</div>
				
				<div class='form-group'>
					<label class='col-md-2 control-label'>语言</label>
					<div class='col-md-10'>
						<input class='form-control' placeholder='语言' type='text'
							name='language' id='Language' data-bv-notempty='false'
							data-bv-notempty-message='语言 可以为空'>
					</div>
				</div>
				
				<div class='form-group'>
					<label class='col-md-2 control-label'>是否通过<font
						style="color: red">*</font></label>
					<div class='col-md-10'>
						<select class="form-control" id="Status" name="status">
							<option selected="selected">请选择...</option>
							<option value="1">通过</option>
							<option value="0">不通过</option>
						</select>
					</div>
				</div>
				
				<!-- <div class='form-group'>
					<label class='col-md-2 control-label'>图片</label>
					<div class='col-md-10'>
						<input class='form-control' placeholder='图片' type='text'
							name='image' id='Image' data-bv-notempty='false'
							data-bv-notempty-message='图片 可以为空'>
					</div>
				</div> -->
				
				<div class="form-group">
				    <input type="hidden" name="image"  id="Image"/>
					<label class="col-md-2 control-label">图片</label>
					<div class="col-md-10">
						<div class="layui-upload-drag" id="filmImage"></div>
						<span class="help-block" id="plogoblock">不能超过1000KB，建议大小340*470</span>
						<img class="" src="" id="preview" width="118" height="118">
					    <p id="resultMsg"></p>
					</div>
				</div>

				<div class='form-group'>
					<label class='col-md-2 control-label'>预告片</label>
					<div class='col-md-10'>
						<input class='form-control' placeholder='预告片' type='text'
							name='trailer' id='Trailer' data-bv-notempty='false'
							data-bv-notempty-message='预告片 可以为空'>
					</div>
				</div>
				
				<div class="form-actions">
					<div class="row" align="center">
						<div class="col-md-12">
							<button class="btn btn-primary"
								onclick="location.href='filminfosList.html'">返回</button>
							<button class="btn btn-primary" type="submit" onclick="update()">
								<i class="fa fa-save"></i> 保存
							</button>
						</div>
					</div>
				</div>

			</fieldset>
		</form>
	</div>
	
<!--选择导演页面  -->
<div id="chooseDirector" style="background-color:lightgray;width:100%;height:800px;z-index:99;position: relative; background: rgba(0, 0, 0, 0.5);display:none">
          <div style="margin-left:10%;margin-top:10%;background-color:white;width:70%;height:300px; opacity:1;z-index: 999;position:absolute;">
               	
	        	<div>
	                <header style="height: 100%">
	                    <div align="left">
		                    <table style="width: 100%">
		                   		<tr>
		                   			<td>
			                   			<form class="form-inline" onsubmit="return false">
											<div class="form-group">
												<input id="DirectorName" type="text" class="form-control" placeholder="导演名称">
												<button id="searchBtdi" class="layui-btn layui-btn-sm"><i class="layui-icon">&#xe615;</i>查询</button>
											</div>
										</form>
		                   			</td>
		                   		</tr> 
		                    </table>
						</div>
	                </header>
	                
	                <div>
	                    <div class="widget-body no-padding">
	                        <table id="dt-table" class="table table-striped table-bordered table-hover" style="width:100%">
	                            <thead>
	                                <tr>
	                                </tr>                       
	                                <tr>
										<th>#</th>
										<th width="10%">选择</th>
										<th >图片</th>
										<th width="10%">导演名称</th>
										<th width="10%">国家</th>
										<th>介绍</th>
	                                </tr>
	                            </thead>
	                            <tbody>
	                            </tbody>
	                        </table>
	                    </div>
	                    <div class="form-actions">
							<div class="row" align="center">
								<div class="col-md-12">
								    <button class="btn btn-primary" id="closeDirector" style="position: absolute;left:40%">关闭</button>
									<button class="btn btn-primary" id="saveDirector"  style="position: absolute;left:50%">
										<i class="fa fa-save"></i> 保存
									</button>
								</div>
							</div>
						</div>
	                </div>
	                
	            </div>
       		</div>     	
</div>

<!--选择演员页面  -->
<div id="chooseActor" style="background-color:lightgray;width:100%;height:800px;z-index:99;position: relative; background: rgba(0, 0, 0, 0.5);display:none">
          <div style="margin-left:10%;margin-top:10%;background-color:white;width:70%;height:300px; opacity:1;z-index: 999;position:absolute;">
               	
	        	<div>
	                <header style="height: 100%">
	                    <div align="left">
		                    <table style="width: 100%">
		                   		<tr>
		                   			<td>
			                   			<form class="form-inline" onsubmit="return false">
											<div class="form-group">
												<input id="ActorName" type="text" class="form-control" placeholder="演员名称">
												<button id="searchBtac" class="layui-btn layui-btn-sm"><i class="layui-icon">&#xe615;</i>查询</button>
											</div>
										</form>
		                   			</td>
		                   		</tr> 
		                    </table>
						</div>
	                </header>
	                
	                <div>
	                    <div class="widget-body no-padding">
	                        <table id="ac-table" class="table table-striped table-bordered table-hover" style="width:100%">
	                            <thead>
	                                <tr>
	                                </tr>                       
	                                <tr>
										<th>#</th>
										<th width="10%">选择</th>
										<th>图片</th>
										<th width="10%">演员名称</th>
										<th width="10%">国家</th>
										<th>介绍</th>
	                                </tr>
	                            </thead>
	                            <tbody>
	                            </tbody>
	                        </table>
	                    </div>
	                    <div class="form-actions">
							<div class="row" align="center">
								<div class="col-md-12">
								    <button class="btn btn-primary" id="closeActor" style="position: absolute;left:40%">关闭</button>
									<button class="btn btn-primary" id="saveActor"  style="position: absolute;left:50%">
										<i class="fa fa-save"></i> 保存
									</button>
								</div>
							</div>
						</div>
	                </div>
	                
	            </div>
       		</div>     	
</div>

	<script type="text/javascript" src="../../js/libs/jquery-2.1.1.min.js"></script>
	<script type="text/javascript" src="../../js/jq.js"></script>
	<script type="text/javascript" src="../../js/plugin/bootstrapvalidator/bootstrapValidator.min.js"></script>
	<script type="text/javascript" src="../../js/plugin/datatables/jquery.dataTables.min.js"></script>
	<script type="text/javascript" src="../../js/plugin/datatables/dataTables.bootstrap.min.js"></script>
	<script type="text/javascript" src="../../js/common.js"></script>
	<script type="text/javascript" src="../../layui/layui.js"></script>
	<script type="text/javascript" src="../../js/my/permission.js"></script>
	<script type="text/javascript">
	layui.use([ "jquery", "upload", "form", "layer", "element" ],function() {
		var $ = layui.$, element = layui.element, layer = layui.layer, upload = layui.upload, form = layui.form;
		//拖拽上传
		var uploadInst = upload.render({
				elem : '#filmImage',
				url : '/filminfos/upload/filmImage',
				size : 500,
				before : function(obj) {
					//预读本地文件示例，不支持ie8
					obj.preview(function(index,file, result) {
						$('#preview').attr('src',result); //图片链接（base64）
					});
				},
				done : function(res) {
					//如果上传失败
					if (res.code > 0) {
						return layer.msg('上传失败');
					}
					//上传成功
					//打印后台传回的地址: 把地址放入一个隐藏的input中, 和表单一起提交到后台, 此处略..
					console.log(res.data.src);
					$("#Image").val(res.data.src);//将地址存储好
					window.parent.uploadHeadImage(res.data.src);
					var resultMsg = $('#resultMsg');
					resultMsg.html('<span style="color: #8f8f8f;">上传成功!!!</span>');
				},
				error : function() {
					//演示失败状态，并实现重传
					var resultMsg = $('#resultMsg');
					resultMsg
							.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-mini demo-reload">重试</a>');
					resultMsg.find('.demo-reload').on(
							'click', function() {
								uploadInst.upload();
							});
				}
			});
		element.init();
	});
	
	layui.use([ 'layer', 'laydate' ], function() {
		var layer = layui.layer;
		var laydate = layui.laydate;
	    laydate.render({
	       elem: '#PublishDate',
	       type: 'datetime'
	    });
	});

		initData();
		function initData() {
			var id = getUrlParam("id");
			if (id != "") {
				$.ajax({
					type : 'get',
					url : '/filminfos/' + id,
					async : false,
					success : function(data) {
						$('#Id').val(data.id);
						$('#FilmCode').val(data.filmCode);
						$('#FilmName').val(data.filmName);
						$('#Version').val(data.version);
						$('#Duration').val(data.duration);
						$('#PublishDate').val(data.publishDate);
						$('#Publisher').val(data.publisher);
						$('#Producer').val(data.producer);
						$('#DirectorId').val(data.directorId);
						$('#Director').val(data.director);
						$('#CastId').val(data.castId);
						$('#Cast').val(data.cast);
						$('#Introduction').val(data.introduction);
						$('#Score').val(data.score);
						$('#Area').val(data.area);
						$('#Type').val(data.type);
						$('#Language').val(data.language);
						$('#Status').val(data.status);
						$('#Image').val(data.image);
						$('#preview').attr("src", data.image);
						$('#Trailer').val(data.trailer);
						
						if(data.directorId != null){
							var direidlist = data.directorId.split(",");
							var direnamelist = data.director.split(",");
							for(var i=0;i<direidlist.length;i++){
								var divd = "<div class='form-inline' title="+direidlist[i]+" value="+direnamelist[i]+" >"+
			    				"<input class='form-control' name='dire' value='"+direnamelist[i]+"'  style='width:200px;'>"+
			    				"<button style='width:150px;color:blue; background-color:transparent; border:0' onclick='delDirector(this)'>删除</button>"+
			    				"</div><br/>";

								$("#selectedDirector").append(divd);
							}
						}
						
						if(data.castId != null){
							var castidlist = data.castId.split(",");
							var castNamelist = data.cast.split(",");
							for(var i=0;i<castidlist.length;i++){
								var diva = "<div class='form-inline' title="+castidlist[i]+" value="+castNamelist[i]+" >"+
			    				"<input class='form-control' name='act' value='"+castNamelist[i]+"'  style='width:200px;'>"+
			    				"<button style='width:150px;color:blue; background-color:transparent; border:0' onclick='delActor(this)'>删除</button>"+
			    				"</div><br/>";

								$("#selectedActor").append(diva);
							}
						}
						
					}
				});
			}
		}

		function update() {
			$('#form').bootstrapValidator();
			var bootstrapValidator = $("#form").data('bootstrapValidator');
			bootstrapValidator.validate();
			if (!bootstrapValidator.isValid()) {
				return;
			}

			//获取选中的导演
		    var dire=[]; 
		    $("#selectedDirector>div").each(function(){
		    	dire.push($(this).attr('title'));
	        })
		    $("#DirectorId").val(dire);
		    
		  	//获取选中的演员
		    var act=[]; 
		    $("#selectedActor>div").each(function(){
		    	act.push($(this).attr('title'));
	        })
		    $("#CastId").val(act);
		    
			var formdata = $("#form").serializeObject();
	console.log(JSON.stringify(formdata));
			$.ajax({
				type : 'put',
				url : '/filminfos',
				contentType : "application/json; charset=utf-8",
				data : JSON.stringify(formdata),
				success : function(data) {
					layer.msg("修改成功", {
						shift : -1,
						time : 1000
					}, function() {
						location.href = "filminfosList.html";
					});
				}
			});
		}
		
		
		//选择导演-弹窗
		$("#getDirector").click(function(){
			$("#chooseDirector").show();
			
		});
		
		$("#closeDirector").click(function(){
			$("[name='dicheckbox']").prop("checked",false);//取消全选
			$("#DirectorName").val("");
			$("#chooseDirector").hide();
		});
		
		//选好导演保存
		$("#saveDirector").click(function(){	
		    $('input[name="dicheckbox"]:checked').each(function(){
		    	var divd = "<div class='form-inline' title="+$(this).attr('title')+" value="+$(this).val()+" >"+
		    				"<input class='form-control' name='dire' value="+$(this).val()+"  style='width:200px;'>"+
		    				"<button style='width:150px;color:blue; background-color:transparent; border:0' onclick='delDirector(this)'>删除</button>"+
		    				"</div><br/>";

				$("#selectedDirector").append(divd);
				
	        })
	        
		    $("[name='dicheckbox']").prop("checked",false);//取消全选
		    $("#DirectorName").val("");
		    $("#chooseDirector").hide();
		});
		
		//删除选好的导演
		function delDirector(Obj){
			Obj.parentNode.parentNode.removeChild(Obj.parentNode);
		}
		
		var	exampled;
		showDirector();
		function showDirector(){
			exampled = 
		    	$('#dt-table').DataTable({
		        	"searching": false,
		        	"processing": false,
		        	"serverSide" : true,
		        	"language": {
		                "url": "/js/plugin/datatables/Chinese.lang"
		            },
		        	"ajax": {
		        		"url" : "/directors",
		        		"type":"get",
		        		"data":function(d){
		    				d.Name = $("#DirectorName").val();
		    			}
		        	},
		        	"dom": "<'dt-toolbar'r>t<'dt-toolbar-footer'<'col-sm-10 col-xs-12 hidden-xs'i><'col-xs-12 col-sm-10' p v>>",	
		            "columns": [
			        	{			"data" : null, 
			            			"defaultContent" : "",
									"render" : function(data, type, full, meta){
										return meta.row + 1 + meta.settings._iDisplayStart;
									}
						},
						{
									"data" : "", 
									"defaultContent" : "",
									"render": function (data, type, row) {
										var id = row['id'];
										var diName = row['name'];
				                		var checkbox = "<input type='checkbox' name='dicheckbox' title="+id+" value="+diName+"  >";
				                		
				                        return checkbox;
				                  	}
						},
						{
									"data" : "picture", 
									"defaultContent" : "",
									"render": function (data, type, row) {
				                		var picture = row['picture'];
				                      	var img = "<img class='dpicture' style='width:40px;height: 40px;' src='"+picture+"' title='"+picture+"' >";
				                      	
				                        return img;
				                  	}
						},
						{"data" : "name", "defaultContent" : ""},
						{"data" : "country", "defaultContent" : ""},
						{
							"data" : "introduction", 
							"defaultContent" : "",
							"render":function(data, type, row){
								if (type === 'display') {
					                if (data != null && data.length > 60) {
					                    return '<span title="' + data + '">' + data.substr(0, 60) + '...</span>';
					                } else {
					                    return '<span title="' + data + '">' + data + '</span>';
					                }
					            }
					            return data;
							}	
						},
		            ],
		           "order": [[ 0, "asc" ]]
		        });
		}
		
		
		$("#searchBtdi").click(function(){
			exampled.ajax.reload();
		});
		
		
		//选择演员-弹窗
		$("#getActor").click(function(){
			$("#chooseActor").show();
			
		});
		
		$("#closeActor").click(function(){
			$("[name='acheckbox']").prop("checked",false);//取消全选
			$("#ActorName").val("");
			$("#chooseActor").hide();
		});
		
		//选好演员保存
		$("#saveActor").click(function(){	
		    $('input[name="acheckbox"]:checked').each(function(){
		    	var diva = "<div class='form-inline' title="+$(this).attr('title')+" value="+$(this).val()+" >"+
		    				"<input class='form-control' name='act' value="+$(this).val()+"  style='width:200px;'>"+
		    				"<button style='width:150px;color:blue; background-color:transparent; border:0' onclick='delActor(this)'>删除</button>"+
		    				"</div><br/>";

				$("#selectedActor").append(diva);
				
	        })
	        
		    $("[name='acheckbox']").prop("checked",false);//取消全选
		    $("#ActorName").val("");
		    $("#chooseActor").hide();
		});
		
		//删除选好的演员
		function delActor(Obj){
			Obj.parentNode.parentNode.removeChild(Obj.parentNode);
		}
		
		var	examplea;
		showActor();
		function showActor(){
			examplea = 
		    	$('#ac-table').DataTable({
		        	"searching": false,
		        	"processing": false,
		        	"serverSide" : true,
		        	"language": {
		                "url": "/js/plugin/datatables/Chinese.lang"
		            },
		        	"ajax": {
		        		"url" : "/actors",
		        		"type":"get",
		        		"data":function(d){
		    				d.Name = $("#ActorName").val();
		    			}
		        	},
		        	"dom": "<'dt-toolbar'r>t<'dt-toolbar-footer'<'col-sm-10 col-xs-12 hidden-xs'i><'col-xs-12 col-sm-10' p v>>",	
		            "columns": [
			        	{			"data" : null, 
			            			"defaultContent" : "",
									"render" : function(data, type, full, meta){
										return meta.row + 1 + meta.settings._iDisplayStart;
									}
						},
						{
									"data" : "", 
									"defaultContent" : "",
									"render": function (data, type, row) {
										var acId = row['id'];
										var acName = row['name'];
				                		var checkbox = "<input type='checkbox' name='acheckbox' title="+acId+" value="+acName+"  >";
				                		
				                        return checkbox;
				                  	}
						},
						{
									"data" : "picture", 
									"defaultContent" : "",
									"render": function (data, type, row) {
				                		var picture = row['picture'];
				                      	var img = "<img class='apicture' style='width:40px;height: 40px;' src='"+picture+"' title='"+picture+"' >";
				                      	
				                        return img;
				                  	}
						},
						{"data" : "name", "defaultContent" : ""},
						{"data" : "country", "defaultContent" : ""},
						{
							"data" : "introduction", 
							"defaultContent" : "",
							"render":function(data, type, row){
								if (type === 'display') {
					                if (data != null && data.length > 60) {
					                    return '<span title="' + data + '">' + data.substr(0, 60) + '...</span>';
					                } else {
					                    return '<span title="' + data + '">' + data + '</span>';
					                }
					            }
					            return data;
							}	
						},
		            ],
		           "order": [[ 0, "asc" ]]
		        });
		}
		
		
		$("#searchBtac").click(function(){
			examplea.ajax.reload();
		});
		
	</script>
</body>
</html>

