<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<link rel="stylesheet" type="text/css" media="screen" href="../../css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" media="screen" href="../../css/dataTables.bootstrap.min.css">
<link rel="stylesheet" href="../../layui/css/layui.css" media="all" />
<link rel="stylesheet" type="text/css" media="screen" href="../../css/conpongroupList.css"/>
</head>
<body>
    <div id="show">
    <input type="text" id="userId" hidden>
    <input type="text" id="roleId" hidden>
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
            <div>
                <header style="height: 100%">
                    <div align="left">
	                    <select  class="form-control" style="width:180px;float:left" name="city" >
						  <option value="">衢州</option>
						  <option value="010">杭州</option>
						  <option value="021">宁波</option>
						  <option value="0571">嘉兴</option>
						</select>  
						<select class="form-control" style="width:180px;float:left;margin-left:1%" name="cinema" id="cinemaName">
						</select>
						<button class="layui-btn layui-btn-sm" id="add">
                                      <i class="layui-icon">&#xe608;</i> 新建优惠券
                                    </button>
						<!-- <div id="add">+新建优惠券</div> -->
					</div>
                </header>
                
                <div style="margin-top:1%">
                    <div class="widget-body no-padding">
                        <table id="dt-table" class="table table-striped table-bordered table-hover" style="width:100%">
                            <thead>
                                <tr>
                                </tr>                       
                                <tr>
									<th>#</th>
									<th>影院编码</th>
									<th>卡券类型</th>
									<th>卡券名称</th>
									<th>有效期</th>
									<th>状态</th>
									<th>价格</th>
									<th>总投放</th>
									<th>已领取</th>
									<th>库存</th>
									<th>已使用</th>
									<th>优惠券管理</th>
									<th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="choose">
    	<div class="choose-form">
        <div class="choose-content">
            <div class="choose-cancel">
                <span class="type-cancel">
                   ×
                </span>
            </div>
            <div class="choose-type">
                <div class="choose-title">选择创建优惠券类型</div>
                <form class="type-form">
                    <div class="choose-top">
                        <input type="radio" class="vouchers choose-inp" value="vouchers" name="type">&nbsp;&nbsp;<span class="choose-font">代金券</span>
                        <div class="type-instructions">可为用户提供抵扣现金服务。可设置为“满*元，减*元”</div>
                    </div>
                    <div class="choose-bottom">
                        <input type="radio" class="exchange choose-inp" value="exchange" name="type">&nbsp;&nbsp;<span class="choose-font">兑换券</span>
                        <div class="type-instructions">可为用户提供消费送赠品服务</div>
                    </div>
                </form>
            </div>
            <button class="layui-btn layui-btn-lg layui-btn-normal type-sure">确认</button>
        </div>
    </div>
    </div>
    	<!-- 创建优惠券 -->
    <div id="create" style="display:none">
   		<div class="vouchers-title create-title">创建代金券</div>
   		<div class="exchange-title create-title">创建兑换券</div>
   		<div class="create-content">
   			<div class="create-head">
	   			<div class="head-title">
	   				填写优惠券信息
	   			</div>
	   			<div class="head-bottom">
	   				基本信息
	   			</div>
   			</div>
   			<div class="content-info">
   				<div class="info-name">
   					<div class="vouchers-describe describe">代金券名称</div>
   					<div class="exchange-describe describe">兑换券名称</div>
   					<input class="name-inp">
   				</div>
   				<div class="info-time">
   					<div class="describe">有效期</div>
   					<div class="time-inp">
   						<form>
	   						<div class="time-top">
							    <input type="radio" class="time-radio" value="fixed" name="time">&nbsp;&nbsp;<span class="time-font">固定日期</span>
							    <input type="text" id="test1" placeholder="请选择时间">
							    <span class="time-to">至</span>
							    <input type="text" id="test2" placeholder="请选择时间">
							    <br>
					      	</div>
					      	<div class="time-bottom">
					      		<input type="radio" class="time-radio" value="after" name="time" checked>&nbsp;&nbsp;<span class="time-font">领取后,</span>
					      		<select name="choose-time" class="choose-time">
								  <option value="">当天</option>
								  <option value="">明天</option>
								  <option value="">后天</option>
								</select>
								<span class="effective-font">生效,有效天数</span>
								<select name="effective-time" class="effective-time">
								  <option value="">30天</option>
								  <option value="">29天</option>
								  <option value="">28天</option>
								</select>
					      	</div>
				      	</form>
				    </div>
   				</div>
   				<div class="info-period">
   					<div class="describe">可用时段</div>
   					<div class="time-inp">
   					<form>
   						<div class="time-top">
						    <input type="radio" class="time-radio" value="fixed" name="time">&nbsp;&nbsp;<span class="time-font">全部时段</span>
				      	</div>
				      	<div class="time-bottom">
				      		<input type="radio" class="time-radio" value="after" name="time" checked>&nbsp;&nbsp;<span class="time-font">部分时段</span>
				      	</div>
				    </form>
				    </div>
				    <br>
				    <br>			          		
			      	<div class="week">
			      		<span class="week-date">日期：</span>
			      		<form class="week-form">
			      			<div class="week-day">
			      				<input type="radio" class="week-radio" value="monday" name="week"><span class="week-font">周一</span>
			      			</div>
				      		<div class="week-day">
				      			<input type="radio" class="week-radio" value="tuesday" name="week"><span class="week-font">周二</span>
				      		</div>	
				      		<div class="week-day">
				      			<input type="radio" class="week-radio" value="wednesday" name="week"><span class="week-font">周三</span>
				      		</div>
				      		<div class="week-day">
				      			<input type="radio" class="week-radio" value="thursday" name="week"><span class="week-font">周四</span>
				      		</div>
				      		<div class="week-day">
				      			<input type="radio" class="week-radio" value="friday" name="week"><span class="week-font">周五</span>
				      		</div>
				      		<div class="week-day">
				      			<input type="radio" class="week-radio" value="saturday" name="week"><span class="week-font">周六</span>
				      		</div>
				      		<div class="week-day">
				      			<input type="radio" class="week-radio" value="sunday" name="week"><span class="week-font">周日</span>
				      		</div>	      			
			      		</form>
			      	</div>	
			      	<div class="other">
			      		<span class="other-time">其他时间</span>
			      		<div class="other-data">
			      			<input class="other-inp">&nbsp;至&nbsp;<input class="other-inp">
			      			<span class="other-add">添加时段</span>
			      			<span class="other-del">删除时段</span>
			      		</div>
			      		<div class="other-font">请使用24小时制输入时间，格式如11:00至14:30</div>
			      	</div>
   				</div>
   				<div class="head-bottom">
	   				优惠详情
	   			</div>
   			</div>
   			<div class="content-details">
    <div class="det-name">
        <div class="limit">领券限制</div>
        <span class="limit-choose">(选填)</span>
        <input class="det-inp">
        <span class="limit-num">张</span>
        <span class="inp-choose">每个用户领券上限，如不填，则默认为1</span>
    </div>
    <div class="det-breaks">
        <div class="breaks-money">减免金额</div>
        <div class="breaks-content">
            <form>
                <input type="radio" class="breaks-radio all-movie" value="all" name="movie">
                <span class="breaks-font">全部影片&nbsp;&nbsp;减</span>
                <input type="text" class="breaks-inp">
                <span class="breaks-font">金额</span>
                <input type="radio" class="breaks-radio appoint-movie" value="appoint" name="movie">
                <span class="breaks-font">指定影片可用</span>
            </form>
            <div class="appoint-content">
                <div class="triangle">
                    <div class="triangle-child"></div>
                </div>
                <div class="movie-inp">
                    <input type="text" class="movie-search" placeholder="请输入影片名称">
                    <span class="movie-less">至少选择一个影片</span>
                </div>
                <ul class="movie-content">
                    <li class="content-type">
                        <span class="type-name">影片名称</span>
                        <span class="type-time">上映时间</span>
                    </li>
                    <li class="movie-all">
                        <span class="movie-name">复仇者联盟4：终局之战</span>
                        <span class="movie-time">2019-4-24</span>
                        <span class="movie-del">删除</span>
                    </li>
                </ul>
            </div>
            <form class="goods">
                <input type="radio" class="breaks-radio" value="all" name="goods">
                <span class="breaks-font">全部卖品&nbsp;&nbsp;减</span>
                <input type="text" class="breaks-inp">
                <span class="breaks-font">金额</span>
                <span class="goods-add">+添加指定卖品</span>
                <div class="goods-shall">
                    <span class="shall-font">优惠共享</span>
                    <select name="add" class="shall-type">
                        <option value="">请选择</option>
                        <option value="no">不与其他优惠叠加使用</option>
                        <option value="yes">可与其他优惠叠加使用</option>
                    </select>
                </div>
            </form>
        </div>
    </div>
    <div class="notice">
        <div class="notice-title">使用须知</div>
        <span class="notice-choose">(选填)</span>
        <textarea placeholder="请填写使用本优惠券注意事项" class="notice-text"></textarea>
    </div>
    <div class="inventory">
        <div class="inven-title">库存</div>
        <input class="inven-inp">
        <span class="inven-choose">份，自动生成相应券码（可在优惠券管理<span><a>券码</a></span>处下载）</span>
        <span class="inven-num">库存只能是大于0的数字</span>
    </div>
    <div class="apply">
        <div class="apply-title">适用门店</div>
        <form class="shop">
                <input type="radio" name="shop" value="all" class="shop-radio shop-all">
                <span class="apply-font">全部门店适用</span>
            <br>
            <br>
                <input type="radio" name="shop" value="appoint" class="shop-radio shop-appoint">
                <span class="apply-font">指定门店</span>
        </form>
        <div class="appoint-shop" id="appoint-shop">
        </div>
    </div>
</div>
</div>	
	<button class="layui-btn layui-btn-lg layui-btn-normal cancel">取消</button>
    <button class="layui-btn layui-btn-lg layui-btn-normal confirm">确认创建</button>	
</div>
</body>
</html>

<script type="text/javascript" src="../../js/libs/jquery-2.1.1.min.js"></script>
<script type="text/javascript" src="../../js/jq.js"></script>
<script type="text/javascript" src="../../js/plugin/datatables/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="../../js/plugin/datatables/dataTables.bootstrap.min.js"></script>
<script type="text/javascript" src="../../layui/layui.js"></script>
<script type="text/javascript" src="../../js/my/permission.js"></script>
<script type="text/javascript">
window.onload=function(){
	$("tbody").on('mouseenter','.span',function(){
		$(this).css("cursor","pointer");
		$(this).css("color","#FF8000");
	})
	$("tbody").on('mouseleave','.span',function(){
		$(this).css("color","#0000E3");
	})
	$("tbody").on('click','.span',function(){
		window.location.href="conponsList.html?groupCode="+$(this).attr('title');
	})
	//获取影院列表
	getCinema();
	function getCinema(){
		$.ajax({
			url:'/users/getCinemaName',
			data:{"id":$("#userId").val(),"roleId":$("#roleId").val()},
			type:'post',
			success:function(data){
				for(var i=0; i<data.length; i++){
					var option = "<option value="+data[i].cinemaCode+">"+data[i].cinemaName+"</option>";
					var cinema = "<div class='shop-name'>";
					cinema = cinema + "<input type='checkbox' name='cinema'>"
					cinema = cinema + "<span value="+data[i].cinemaCode+">"+data[i].cinemaName+"</span>"
					cinema = cinema + "</div>";
					$("#cinemaName").append(option);
					$("#appoint-shop").append(cinema);
				}
			}
		});
	}
}

initUser();
function initUser(){
	$.ajax({
		type : 'get',
		url : '/users/current',
		async : false,
		success : function(data) {
			$("#userId").val(data.id);
			$("#roleId").val(data.roleId);
		}
	});
} 

/*创建优惠券  */
	$(".type-sure").click(function(){
        var val=$('input:radio[name="type"]:checked').val();
        if(val==null){
            alert("请选择优惠券类型！");
            return false;
        }
        else if (val === "vouchers") {
        	$("#create").css("display","block");
        	$("#choose").css("display","none");
        	$("#show").css("display","none");
        	$(".exchange-title").css("display","none");
        	$(".exchange-describe").css("display","none");
        }
        else if (val === "exchange") {
        	$("#create").css("display","block");
        	$("#choose").css("display","none");
        	$("#show").css("display","none");
        	$(".vouchers-title").css("display","none");
        	$(".vouchers-describe").css("display","none");
        }
    });
	$("#add").click(function(){
		$("#choose").css("display","block");
	});
	$(".type-cancel").click(function(){
		$("#choose").css("display","none");
	})
	$(".cancel").click(function(){
		$("#create").css("display","none");
		$("#show").css("display","block");
		$(".exchange-title").css("display","block");
    	$(".exchange-describe").css("display","block");
    	$(".vouchers-title").css("display","block");
    	$(".vouchers-describe").css("display","block");
	});
	$(".confirm").click(function(){
		$("#create").css("display","none");
		$("#show").css("display","block");
		$(".exchange-title").css("display","block");
    	$(".exchange-describe").css("display","block");
    	$(".vouchers-title").css("display","block");
    	$(".vouchers-describe").css("display","block");
	});
	$(".appoint-movie").click(function () {
        $(".appoint-content").css("display","block");
    });
    $(".all-movie").click(function () {
        $(".appoint-content").css("display","none");
    });
    function stopPropagation(e) {
        let ev = e || window.event;
        if (ev.stopPropagation) {
            ev.stopPropagation();
        }
        else if (window.event) {
            window.event.cancelBubble = true;
        }
    }
    $(".inven-inp").click(function (e) {
        $(".inven-num").show();
        stopPropagation(e);
    });
    $(document).bind('click', function () {
        $(".inven-num").hide();
    });
    $(".inven-num").click(function (e) {
        stopPropagation(e);
    });
    $(".shop-appoint").click(function () {
        $(".appoint-shop").css("display","block");
    });
    $(".shop-all").click(function () {
        $(".appoint-shop").css("display","none");
    });
/*优惠券管理 */	
	var pers = checkPermission();
	
	var example;
	function init(){
		example = 
	    	$('#dt-table').DataTable({
	        	"searching": false,
	        	"processing": false,
	        	"serverSide" : true,
	        	"language": {
	                "url": "/js/plugin/datatables/Chinese.lang"
	            },
	        	"ajax": {
	        		"url" : "/conpongroups",
	        		"type":"get",
	        		"data":function(d){
	    				d.CinemaCode = $("#cinemaName").val();
	    			}
	        	},
	        	"dom": "<'dt-toolbar'r>t<'dt-toolbar-footer'<'col-sm-10 col-xs-12 hidden-xs'i><'col-xs-12 col-sm-10' p v>>",	
	            "columns": [
	            	{"data" : null, "defaultContent" : "","orderable":false,
						"render" : function(data, type, full, meta){
							return meta.row + 1 + meta.settings._iDisplayStart;
							}
					},
					{"data" : "cinemaCode", "defaultContent" : "","orderable":false},
					{"data" : "typeName", "defaultContent" : "","orderable":false,
						"render":function(data, type, row){
							var conpontype = row['conpongroup'];
							var typeName = row['conpontype'];
							return typeName['typeName'];
						}
					},
					{"data" : "groupName", "defaultContent" : "","orderable":false},
					{"data" : "validityDate", "defaultContent" : "","orderable":false},
					{"data" : "", "defaultContent" : "0","orderable":false},
					{"data" : "price", "defaultContent" : "","orderable":false},
					{"data" : "conponNumber", "defaultContent" : "","orderable":false},
					{"data" : "received", "defaultContent" : "0","orderable":false},
					{"data" : "unused", "defaultContent" : "0","orderable":false},
					{"data" : "used", "defaultContent" : "0","orderable":false},
					{"data" : "", "defaultContent" : "","orderable":false,
						"render":function(data, type, row){
							var groupCode = row['groupCode'];
							return '<span style="color:#0000E3" class="span" title="'+groupCode+'">券码管理</span>';
						}
					},
					{ 
									"data": "", 
									"defaultContent": "",
									"orderable":false,
							        "render": function (data, type, row) {
							        	var id = row['id'];
	                		           var del = buttonDel(id, "", pers);
	                                   return del;
	                  	            }		
								},
	                
	            ],
	           "order": [[ 0, "asc" ]]
	        } );
	}
	
	layui.use('layer', function(){
	    var layer = layui.layer;
	});
	/*时间选择插件 */
	layui.use('laydate', function(){
		  var laydate = layui.laydate;
		  //执行一个laydate实例
		  laydate.render({
		    elem: '#test1' //指定元素
		  });
		  laydate.render({
		    elem: '#test2' //指定元素
		  });
		});
	function del(id){
		layer.confirm('确定要删除吗？', {
	        btn : [ '确定', '取消' ]
	    }, function() {
	    	$.ajax({
	            type : 'delete',
	            url : '/conpongroups/'+id,
	            success : function(data) {
	                example.ajax.reload();
	                layer.msg("删除成功");
	            }
	        });
	        
	        layer.close(1);
	    });
	}
	
	/* $("#searchBt").click(function(){
		example.ajax.reload();
	}); */
	$("#cinemaName").blur(function(){
		example.ajax.reload();
	});
	init();
</script>
